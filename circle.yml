machine:
  environment:
    DEBUG: set -x

checkout:
  post:
    - git submodule sync
    - git submodule update --init

dependencies:
  pre:
    - bash -c 'ls -alF /nix ~/.nix* || echo "does not exist"'
  cache_directories:
    - /nix
  override:
    - bin/nix-bootstrap
  post:
    - bash -c 'ls -alF /nix ~/.nix* || echo "does not exist"'

test:
  override:
    - source ~/.nix-profile/etc/profile.d/nix.sh && bin/build
    - bin/site-rebuild

deployment:
  production:
    branch: master
    commands:
      - git config --global user.name 'Steven Shaw'
      - git config --global user.email 'steven@steshaw.org'
      - bin/deploy-to-github-pages "This update brought to you courtesy of Nix and Circle CI (${CIRCLE_BUILD_NUM})"

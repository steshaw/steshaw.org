#!/usr/bin/env bash

# FIXME: Fix the strange we way dump the pdfs into the parent directory
# (i.e. ..).

set -euo pipefail
${DEBUG:-}

if [[ $# -ne 1 ]]; then
  script=$(basename "$0")
  echo "usage: $script talk-name" >&2
  exit 2
fi

name=${1%.org}
src=${name}.org

#  -V revealjs-url:http://lab.hakim.se/reveal-js \
pandoc \
  --smart \
  --standalone \
  --css=https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css \
  -t revealjs \
  --slide-level 2 \
  -V theme:black \
  --output "${name}".html \
  "${src}"

cp "${name}.html" "${name}.1.html"

# Sadly, the setting the theme via the `theme` variable doesn't seem to work. Invoke Perl!
# FIXME: This currently doesn't change anything. It seems that the theme is set
#        appropriately. Probably because we bumped the version of pandoc.
perl -p -e 's/simple\.css/black.css/; s/reveal\.min\./reveal./' -i "${name}.html"

cp "${name}.html" "${name}.2.html"

# When the talk name is "index" use the name of the directory instead.
if [[ $name == 'index' ]]; then
  talkName=$(basename "${PWD}")
  pdfBase="../${talkName}"
else
  pdfBase="${name}"
fi
pdfBase=$(realpath "${pdfBase}") # XXX: Clobbered!

# See https://github.com/astefanutti/decktape#docker
function DeckTapePdf {
  pdf="${pdfBase}.pdf"
  file="${PWD}/${name}.html"

  user="$(id --user):$(id --group)"
#    -v "${pdfBase}:/slides" \
  docker run --rm \
    --user "${user}" \
    -v "${HOME}:${HOME}" \
    astefanutti/decktape:1.0.0 reveal "$file" "$pdf"
  echo decktape exit status = $?
}

function BeamerPdf {
  pdf="${pdfBase}.beamer.pdf"

  if type -p pdflatex >/dev/null; then
    pandoc -t beamer -V theme:Madrid "${src}" -o "${pdf}"
  else
    echo 'Install pdflatex!'
    exit 1
  fi
}

DeckTapePdf
BeamerPdf

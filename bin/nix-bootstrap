#!/usr/bin/env bash

set -eu

pwd
[[ ! -d /nix ]] && curl https://nixos.org/nix/install | sh
source ~/.nix-profile/etc/profile.d/nix.sh
if [[ -d ~/nixpkgs ]]; then
  (cd ~/nixpkgs; git pull)
else
  git clone https://github.com/NixOS/nixpkgs.git ~/nixpkgs
fi

sudo mkdir -p /etc/nix

if [[ "$(uname)" == 'Darwin' ]]; then 
  caches='http://zalora-public-nix-cache.s3-website-ap-southeast-1.amazonaws.com http://cache.nixos.org'
else
  caches='https://cache.nixos.org http://hydra.nixos.org http://hydra.cryp.to'
fi

cat >/tmp/nix.conf <<!
trusted-binary-caches = ${caches}
binary-caches         = ${caches}
!
sudo cp /tmp/nix.conf /etc/nix

nix-env -f ~/nixpkgs -i -A haskellngPackages.cabal2nix -A haskellngPackages.cabal-install
